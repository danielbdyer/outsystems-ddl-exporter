# 16.8 Views, Synonyms, and Abstraction

*These create stable interfaces over changing structures.*

---

### Create a View

**Layer 1**
| Summary | Tier | Mechanism | CDC |
|---------|------|-----------|-----|
| Create a named query as a virtual table | 1 | Pure Declarative | N/A |

---

**Layer 2**

**What you do:**
```sql
-- /Views/dbo/dbo.vw_ActiveCustomer.sql
CREATE VIEW [dbo].[vw_ActiveCustomer]
AS
SELECT 
    CustomerId,
    FirstName,
    LastName,
    Email,
    CreatedAt
FROM dbo.Customer
WHERE IsActive = 1
```

**Always enumerate columns explicitly.** Never use `SELECT *`.

---

**Layer 3: Gotchas & Edge Cases**

| Gotcha | Details |
|--------|---------|
| ðŸ”´ **The SELECT * View** | View schema is fixed at creation. New columns won't appear. See [Anti-Pattern 19.7](#197-the-select--view). |
| Dependency chain | If underlying table changes, view may break. SSDT catches this at build. |

**Related:**
- Anti-pattern: [19.7 The SELECT * View](#197-the-select--view)

---

### Create a View for Backward Compatibility

**Layer 1**
| Summary | Tier | Mechanism | CDC |
|---------|------|-----------|-----|
| Maintain old interface during migration | 2-3 | Part of Multi-Phase pattern | N/A |

---

**Layer 2**

**Scenario:** Renamed table `Employee` to `Staff`. Create view to maintain old name.

```sql
CREATE VIEW [dbo].[Employee]
AS
SELECT 
    StaffId AS EmployeeId,
    FirstName,
    LastName,
    Email
FROM dbo.Staff
```

Old code referencing `dbo.Employee` continues to work.

---

### Create a Synonym

**Layer 1**
| Summary | Tier | Mechanism | CDC |
|---------|------|-----------|-----|
| Create an alias for another object | 1-2 | Pure Declarative | N/A |

---

**Layer 2**

**What you do:**
```sql
-- Same database, different schema
CREATE SYNONYM [dbo].[Customer] FOR [sales].[Customer]

-- Cross-database
CREATE SYNONYM [dbo].[RemoteCustomer] FOR [LinkedServer].[OtherDB].[dbo].[Customer]
```

**Use cases:**
- Schema migration: leave synonym at old location
- Environment abstraction: synonym points to different targets
- Encapsulate linked server complexity

---

**Layer 3: Gotchas & Edge Cases**

| Gotcha | Details |
|--------|---------|
| Runtime resolution | Synonyms resolve at execution, not compile time. If target doesn't exist, runtime error. |
| Cross-database | Requires database reference in SSDT project. |

---

### Create an Indexed View (Materialized)

**Layer 1**
| Summary | Tier | Mechanism | CDC |
|---------|------|-----------|-----|
| Physically store view results for performance | 2-3 | Pure Declarative | N/A |

---

**Layer 2**

**Requirements:**
- `WITH SCHEMABINDING` required
- Deterministic expressions only
- `COUNT_BIG(*)` not `COUNT(*)`
- No OUTER JOIN, subqueries, DISTINCT

```sql
CREATE VIEW [dbo].[vw_CustomerOrderSummary]
WITH SCHEMABINDING
AS
SELECT 
    CustomerId,
    COUNT_BIG(*) AS OrderCount,
    SUM(TotalAmount) AS TotalSpend
FROM dbo.[Order]
GROUP BY CustomerId
GO

CREATE UNIQUE CLUSTERED INDEX [IX_vw_CustomerOrderSummary]
ON [dbo].[vw_CustomerOrderSummary]([CustomerId])
```

---

**Layer 3: Gotchas & Edge Cases**

| Gotcha | Details |
|--------|---------|
| Write overhead | Every INSERT/UPDATE/DELETE on base tables updates the view. |
| Enterprise Edition | Standard Edition requires `NOEXPAND` hint to use indexed view. |

---
