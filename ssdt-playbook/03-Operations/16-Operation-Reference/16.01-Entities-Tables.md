# 16.1 Working with Entities (Tables)

*In OutSystems, these were your Entities. Now they're tables you define explicitly.*

---

### Create a New Entity

**Layer 1**
| Summary | Tier | Mechanism | CDC |
|---------|------|-----------|-----|
| Add a new table to the database | 1 | Pure Declarative | Enable separately if needed |

---

**Layer 2**

**Dimensions:**
| Dimension | Value | Reasoning |
|-----------|-------|-----------|
| Data Involvement | Schema-only | No existing data |
| Reversibility | Symmetric | Delete the file |
| Dependency Scope | Self-contained | Nothing references it yet |
| Application Impact | Additive | Existing code unaffected |

**What you do:**

Create a new `.sql` file in `/Tables/{schema}/`:

```sql
-- /Tables/dbo/dbo.CustomerPreference.sql

CREATE TABLE [dbo].[CustomerPreference]
(
    [CustomerPreferenceId] INT IDENTITY(1,1) NOT NULL,
    [CustomerId] INT NOT NULL,
    [PreferenceKey] NVARCHAR(100) NOT NULL,
    [PreferenceValue] NVARCHAR(500) NULL,
    [CreatedAt] DATETIME2(7) NOT NULL CONSTRAINT [DF_CustomerPreference_CreatedAt] DEFAULT (SYSUTCDATETIME()),
    [CreatedBy] NVARCHAR(128) NOT NULL CONSTRAINT [DF_CustomerPreference_CreatedBy] DEFAULT (SYSTEM_USER),
    
    CONSTRAINT [PK_CustomerPreference] PRIMARY KEY CLUSTERED ([CustomerPreferenceId]),
    CONSTRAINT [FK_CustomerPreference_Customer] FOREIGN KEY ([CustomerId]) 
        REFERENCES [dbo].[Customer]([CustomerId])
)
```

**What SSDT generates:**
```sql
CREATE TABLE [dbo].[CustomerPreference] (...)
```

Verbatim â€” the table doesn't exist, so SSDT creates it.

**Verification:**
- Build succeeds
- Table appears in local database after publish
- Constraints and FKs are in place

---

**Layer 3: Gotchas & Edge Cases**

| Gotcha | Details |
|--------|---------|
| FK to non-existent table | If you reference a table not in your project, build fails. Add the parent table first, or add it to the same PR. |
| Missing from project | If you create the file but don't add it to the project, it won't deploy. Verify in Solution Explorer. |
| CDC enablement | New tables aren't CDC-enabled automatically. If this table needs audit tracking, add CDC enablement to post-deployment. |

**Related:**
- Template: [28.1 New Table Template](#281-new-table-template)
- If CDC needed: [12. CDC and Schema Evolution](#12-cdc-and-schema-evolution)

---

### Rename an Entity

**Layer 1**
| Summary | Tier | Mechanism | CDC |
|---------|------|-----------|-----|
| Change a table's name while preserving data | 3 | Declarative + Refactorlog | Instance recreation required |

---

**Layer 2**

**Dimensions:**
| Dimension | Value | Reasoning |
|-----------|-------|-----------|
| Data Involvement | Schema-only | Data untouched |
| Reversibility | Symmetric | Rename back |
| Dependency Scope | Cross-boundary | Everything references tables by name |
| Application Impact | Breaking | All callers must update |

**What you do:**

1. In Visual Studio Solution Explorer, right-click the table file
2. Select **Rename**
3. Enter the new name
4. Visual Studio updates the file AND creates a refactorlog entry

**What SSDT generates (with refactorlog):**
```sql
EXEC sp_rename 'dbo.OldTableName', 'NewTableName', 'OBJECT'
```

**What SSDT generates (WITHOUT refactorlog):**
```sql
DROP TABLE [dbo].[OldTableName]
CREATE TABLE [dbo].[NewTableName] (...)
-- ALL DATA LOST
```

**Verification:**
- Check `.refactorlog` file was modified
- Schema Compare shows rename, not drop+create
- Generated script uses `sp_rename`

---

**Layer 3: Gotchas & Edge Cases**

| Gotcha | Details |
|--------|---------|
| ðŸ”´ **The Naked Rename** | Editing the file directly without refactorlog causes data loss. See [Anti-Pattern 19.1](#191-the-naked-rename). |
| Dynamic SQL | Any code that constructs table names as strings won't be caught by SSDT's analysis. Search codebase manually. |
| External systems | ETL, reports, and other systems won't update automatically. Coordinate with stakeholders. |
| CDC impact | Capture instance references old table name. Must recreate. |

**Related:**
- Anti-pattern: [19.1 The Naked Rename](#191-the-naked-rename)
- Pattern: [17.8 Schema Migration with Backward Compatibility](#178-pattern-schema-migration-with-backward-compatibility)
- Section: [9. The Refactorlog and Rename Discipline](#9-the-refactorlog-and-rename-discipline)

---

### Delete an Entity

**Layer 1**
| Summary | Tier | Mechanism | CDC |
|---------|------|-----------|-----|
| Remove a table and all its data permanently | 4 | Declarative (guarded by BlockOnPossibleDataLoss) | Disable before drop |

---

**Layer 2**

**Dimensions:**
| Dimension | Value | Reasoning |
|-----------|-------|-----------|
| Data Involvement | Data-destructive | All rows gone |
| Reversibility | Lossy | Backup restore only path back |
| Dependency Scope | Cross-boundary | FKs, views, procs, ETL, reports |
| Application Impact | Breaking | Catastrophic if anything still references |

**What you do:**

1. Follow the deprecation workflow first (soft-deprecate â†’ verify unused â†’ soft-delete)
2. Delete the `.sql` file from the project
3. If `DropObjectsNotInSource=True`, SSDT generates the DROP
4. If `DropObjectsNotInSource=False`, you need a pre-deployment script

**What SSDT generates:**
```sql
DROP TABLE [dbo].[TableName]
```

**Protection:** `BlockOnPossibleDataLoss=True` will halt deployment if table has rows.

**Pre-flight checklist:**
- [ ] Table has been soft-deprecated for defined period
- [ ] Query confirms zero rows or data has been archived
- [ ] `sys.dm_sql_referencing_entities` returns empty
- [ ] Text search across codebase for table name
- [ ] ETL/reporting team confirms no dependencies
- [ ] Backup verified and restoration tested
- [ ] CDC disabled on table (if enabled)

---

**Layer 3: Gotchas & Edge Cases**

| Gotcha | Details |
|--------|---------|
| Foreign keys | If other tables have FKs pointing to this table, drop will fail. Drop those FKs first. |
| DropObjectsNotInSource=False | In production, this setting is usually False. You'll need explicit pre-deployment script to drop. |
| CDC | Disable CDC before dropping table, otherwise CDC objects become orphaned. |
| Views/Procs | Dependent objects will break. SSDT build should catch these if they're in the project. |

**Related:**
- Pattern: [17.5 Safe Column Removal (4-Phase)](#175-pattern-safe-column-removal-4-phase) â€” same workflow applies to tables

---

### Archive an Entity

**Layer 1**
| Summary | Tier | Mechanism | CDC |
|---------|------|-----------|-----|
| Move old data to archive while preserving it | 3-4 | Multi-Phase | Affects both source and destination |

---

**Layer 2**

**Dimensions:**
| Dimension | Value | Reasoning |
|-----------|-------|-----------|
| Data Involvement | Data-transforming | Data moves between tables |
| Reversibility | Effortful | Can restore, but requires scripted work |
| Dependency Scope | Inter-table to Cross-boundary | FKs must be handled; queries need awareness |
| Application Impact | Breaking for archived data | Active data unaffected if partitioned correctly |

**What you do:**

This is a multi-phase operation. SSDT doesn't have "move data" â€” you script it.

**Phase 1: Create archive destination**
```sql
-- Declarative: Create archive table (if new)
CREATE TABLE [archive].[Order_Pre2024] (...)
```

**Phase 2: Migrate data (post-deployment)**
```sql
-- Batch to manage transaction log
WHILE 1=1
BEGIN
    DELETE TOP (10000) FROM dbo.[Order]
    OUTPUT DELETED.* INTO archive.Order_Pre2024
    WHERE OrderDate < '2024-01-01'
    
    IF @@ROWCOUNT = 0 BREAK
END
```

**Phase 3: Verify**
```sql
-- Confirm counts match
SELECT 'Source' AS Location, COUNT(*) FROM dbo.[Order] WHERE OrderDate < '2024-01-01'
UNION ALL
SELECT 'Archive', COUNT(*) FROM archive.Order_Pre2024
```

---

**Layer 3: Gotchas & Edge Cases**

| Gotcha | Details |
|--------|---------|
| Transaction log | Large data movements bloat the log. Batch operations. |
| FKs | Child records must be archived first, or FKs disabled. |
| Cross-database | If archiving to different database, no FK enforcement. Consider different backup/retention policies. |
| CDC | Both tables may need CDC consideration. Archive table typically doesn't need CDC. |

---
