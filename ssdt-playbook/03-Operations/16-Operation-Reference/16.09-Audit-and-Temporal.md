# 16.9 Audit and Temporal

*These patterns track changes over time â€” the foundation of your Change History feature.*

---

### Add System-Versioned Temporal Table

**Layer 1**
| Summary | Tier | Mechanism | CDC |
|---------|------|-----------|-----|
| Enable automatic history tracking | 2 (new) / 3 (existing) | Pure Declarative (new) / Multi-Phase (existing) | Different mechanism than CDC |

---

**Layer 2**

**For new table:**
```sql
CREATE TABLE [dbo].[Employee]
(
    [EmployeeId] INT NOT NULL PRIMARY KEY,
    [Name] NVARCHAR(100) NOT NULL,
    [Department] NVARCHAR(50) NOT NULL,
    
    [ValidFrom] DATETIME2 GENERATED ALWAYS AS ROW START NOT NULL,
    [ValidTo] DATETIME2 GENERATED ALWAYS AS ROW END NOT NULL,
    PERIOD FOR SYSTEM_TIME (ValidFrom, ValidTo)
)
WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.EmployeeHistory))
```

**Querying:**
```sql
-- Current state
SELECT * FROM dbo.Employee

-- Point in time
SELECT * FROM dbo.Employee FOR SYSTEM_TIME AS OF '2024-06-15'

-- Full history
SELECT * FROM dbo.Employee FOR SYSTEM_TIME ALL WHERE EmployeeId = 42
```

---

**Layer 3: Gotchas & Edge Cases**

| Gotcha | Details |
|--------|---------|
| Existing table | Converting existing table to temporal requires multi-phase approach. |
| History table | System-managed; can't directly modify. |
| SSDT table rebuilds | If SSDT needs to rebuild table (column reorder), it disables/re-enables versioning. |

---

### Add Manual Audit Columns

**Layer 1**
| Summary | Tier | Mechanism | CDC |
|---------|------|-----------|-----|
| Add CreatedAt, UpdatedAt, CreatedBy, UpdatedBy columns | 1 (new) / 2 (existing) | Pure Declarative / Post-Deployment for backfill | No CDC impact |

---

**Layer 2**

**Standard audit columns:**
```sql
[CreatedAt] DATETIME2(7) NOT NULL 
    CONSTRAINT [DF_Order_CreatedAt] DEFAULT (SYSUTCDATETIME()),
[CreatedBy] NVARCHAR(128) NOT NULL 
    CONSTRAINT [DF_Order_CreatedBy] DEFAULT (SYSTEM_USER),
[UpdatedAt] DATETIME2(7) NULL,
[UpdatedBy] NVARCHAR(128) NULL
```

**For existing table â€” backfill:**
```sql
UPDATE dbo.[Order]
SET 
    CreatedAt = ISNULL(OrderDate, '2020-01-01'),
    CreatedBy = 'MIGRATION'
WHERE CreatedAt IS NULL
```

---

**Layer 3: Gotchas & Edge Cases**

| Gotcha | Details |
|--------|---------|
| UpdatedAt/UpdatedBy | Database won't auto-populate. Requires trigger or application code. |
| Triggers | Can add trigger for auto-update, but adds overhead. |

---

### Enable Change Data Capture

**Layer 1**
| Summary | Tier | Mechanism | CDC |
|---------|------|-----------|-----|
| Track row-level changes for audit/ETL | 3 | Script-Only | This IS the CDC operation |

---

**Layer 2**

**Enable for database:**
```sql
EXEC sys.sp_cdc_enable_db
```

**Enable for table:**
```sql
EXEC sys.sp_cdc_enable_table
    @source_schema = 'dbo',
    @source_name = 'Customer',
    @role_name = 'cdc_reader',
    @capture_instance = 'dbo_Customer_v1',
    @supports_net_changes = 1
```

**Query changes:**
```sql
DECLARE @from_lsn binary(10) = sys.fn_cdc_get_min_lsn('dbo_Customer_v1')
DECLARE @to_lsn binary(10) = sys.fn_cdc_get_max_lsn()

SELECT * FROM cdc.fn_cdc_get_all_changes_dbo_Customer_v1(@from_lsn, @to_lsn, 'all')
```

---

**Layer 3: Gotchas & Edge Cases**

| Gotcha | Details |
|--------|---------|
| Enterprise Edition | CDC requires Enterprise (or Developer/Eval). |
| SQL Agent | Requires SQL Agent running for capture jobs. |
| Schema changes | Any schema change on CDC table requires capture instance management. See [Section 12](#12-cdc-and-schema-evolution). |
| ðŸ”´ **The CDC Surprise** | Schema changes without instance recreation leave history incomplete. See [Anti-Pattern 19.5](#195-the-cdc-surprise). |

**Related:**
- Section: [12. CDC and Schema Evolution](#12-cdc-and-schema-evolution)
- Anti-pattern: [19.5 The CDC Surprise](#195-the-cdc-surprise)
- Pattern: [17.9 CDC-Enabled Table Schema Change](#179-pattern-cdc-enabled-table-schema-change-production)
- Decision aid: [18.5 CDC Impact Checker](#185-cdc-impact-checker)

---

### Enable Change Tracking

**Layer 1**
| Summary | Tier | Mechanism | CDC |
|---------|------|-----------|-----|
| Lightweight tracking of which rows changed | 2 | Declarative (table) / Script (database) | Alternative to CDC |

---

**Layer 2**

**Simpler than CDC:** Tracks *that* rows changed, not *what* changed.

**Enable for database:**
```sql
ALTER DATABASE [YourDb]
SET CHANGE_TRACKING = ON
(CHANGE_RETENTION = 7 DAYS, AUTO_CLEANUP = ON)
```

**Enable for table:**
```sql
CREATE TABLE [dbo].[Customer]
(
    -- columns
)
WITH (CHANGE_TRACKING = ON)
```

**Query changes:**
```sql
SELECT 
    ct.CustomerId,
    ct.SYS_CHANGE_OPERATION,  -- I, U, D
    c.*
FROM CHANGETABLE(CHANGES dbo.Customer, @last_sync_version) ct
LEFT JOIN dbo.Customer c ON ct.CustomerId = c.CustomerId
```

---

**Layer 3: Gotchas & Edge Cases**

| Gotcha | Details |
|--------|---------|
| No before/after | Only tells you row changed, not old values. |
| Sync scenarios | Good for cache invalidation, offline sync. |
| All editions | Available in all SQL Server editions. |

**CDC vs Change Tracking:**
| Aspect | CDC | Change Tracking |
|--------|-----|-----------------|
| What's tracked | Full before/after row images | Which rows changed |
| Storage | Separate change tables | Internal tracking |
| Edition | Enterprise | All editions |
| Use case | Audit, ETL | Sync, cache invalidation |
| Overhead | Higher | Lower |

---
