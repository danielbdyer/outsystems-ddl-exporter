# M1.2/M1.3 Analysis: Current State vs. Required Enhancements

## Problem Statement

User experienced export failure with message: "Circular dependency detected"
**What's missing**:
- Which tables are involved?
- What is the actual dependency chain (cycle path)?
- Which FKs create the cycle?
- Can this cycle be handled safely (nullable FKs, etc.)?
- What should the operator do to fix or override it?

---

## Current State Analysis

### What Exists ✅

**1. Cycle Detection (EntityDependencySorter)**
- Location: `src/Osm.Emission/Seeds/EntityDependencySorter.cs:123`
- Detection: `var cycleDetected = ordered.Length != nodes.Count;`
- How it works: Kahn's algorithm - if topological sort doesn't order all nodes, a cycle exists
- **Output**: Boolean flag `CycleDetected` in `EntityDependencyOrderingResult`

**2. Fallback Behavior**
- When cycle detected: Appends remaining nodes alphabetically
- Sets flags: `CycleDetected=true`, `AlphabeticalFallbackApplied=true`
- **Result**: Export continues but ordering may be incorrect

**3. Violation Detection (TopologicalOrderingValidator)**
- Location: `src/Osm.Pipeline/Orchestration/TopologicalOrderingValidator.cs`
- Validates AFTER sorting: Checks if parent-child order is correct
- Detects: `ChildBeforeParent` and `MissingParent` violations
- **Output**: `OrderingViolation` records with positions

**4. Current Logging**
- Location: `src/Osm.Pipeline/Orchestration/BuildSsdtBootstrapSnapshotStep.cs:170-172`
- Message: `"-- WARNING: Circular dependencies detected - alphabetical fallback applied"`
- Also logged to telemetry with boolean flag
- **Problem**: No details about WHICH tables or WHY

---

## What's Missing ❌

### 1. **Cycle Path Reconstruction**
**Current**: We know a cycle exists but not which tables form it
**Need**: Extract the actual dependency path (e.g., "User → Organization → Audit → User")

**Technical approach**:
- During Kahn's algorithm, when `indegree` never reaches 0, those are cycle participants
- Use DFS from remaining nodes to find strongly connected components (Tarjan's algorithm)
- Reconstruct path by following edges backward

### 2. **FK Metadata for Diagnostics**
**Current**: We have FK relationships in model but don't extract metadata during cycle detection
**Need**: For each FK in cycle, determine:
- Is it nullable? (Can we INSERT with NULL then UPDATE?)
- What's the delete rule? (CASCADE is dangerous in cycles!)
- FK constraint name (for operator reference)

**Technical approach**:
- Extract from `RelationshipModel.ActualConstraints`
- Map FK columns to `AttributeModel` to check `IsMandatory` (inverse of nullable)
- Include constraint name from `RelationshipActualConstraint.Name`

### 3. **Actionable Recommendations**
**Current**: Generic warning with no guidance
**Need**: Context-specific recommendations:
- "FK_ORG_CREATOR is nullable → safe to load in phases"
- "Both FKs are NOT NULL CASCADE → requires schema change"
- "Self-reference detected → this is normal for hierarchical data"

**Technical approach**:
- Analyze FK metadata to categorize cycle severity
- Provide template recommendations based on patterns

### 4. **Operator Override Mechanism** (M1.3)
**Current**: No way to acknowledge and allow intentional cycles
**Need**: Configuration to allowlist specific cycles

**Technical approach** (future M1.3):
- JSON configuration with allowed cycle paths
- Downgrade from ERROR to WARNING when allowed
- Document WHY cycle was allowed (audit trail)

---

## Proposed Enhancement Strategy

### Phase 1: Enhanced Diagnostics (M1.2 Core)

**Goal**: When cycle detected, provide complete diagnostic information

**Changes**:

1. **Extend `TopologicalValidationResult`** to include cycle details:
```csharp
public sealed record TopologicalValidationResult(
    bool IsValid,
    ImmutableArray<OrderingViolation> Violations,
    int TotalEntities,
    int TotalForeignKeys,
    int MissingEdges,
    bool CycleDetected,

    // NEW: Cycle diagnostic information
    ImmutableArray<CycleDiagnostic> Cycles);  // NEW
```

2. **Add `CycleDiagnostic` model**:
```csharp
public sealed record CycleDiagnostic(
    ImmutableArray<string> TablesInCycle,     // Physical table names
    string CyclePath,                          // "A → B → C → A"
    ImmutableArray<ForeignKeyInCycle> ForeignKeys);

public sealed record ForeignKeyInCycle(
    string ConstraintName,
    string SourceTable,
    string TargetTable,
    string SourceColumn,
    string TargetColumn,
    bool IsNullable,                           // Can be broken for phased loading
    string DeleteRule);                        // CASCADE, SET NULL, NO ACTION
```

3. **Implement cycle extraction in `TopologicalOrderingValidator`**:
   - After detecting `ChildBeforeParent` violations, use those to trace cycle paths
   - Group violations that form cycles
   - Extract FK metadata from `OsmModel`

4. **Update `BuildSsdtBootstrapSnapshotStep`** to emit detailed diagnostics:
   - Replace generic warning with detailed cycle report
   - Include table names, FK names, and recommendations
   - Log to both SQL comment header AND telemetry

### Phase 2: Recommendations Engine (M1.2 Enhancement)

**Goal**: Provide actionable guidance based on cycle characteristics

**Logic**:
```csharp
if (cycle has only nullable FKs)
    → "Safe: Load in phases (INSERT with NULL, then UPDATE)"

if (cycle has mix of nullable and NOT NULL FKs)
    → "Recommend: Make FK_XYZ nullable to enable phased loading"

if (cycle has all NOT NULL FKs)
    → "Schema change required: At least one FK must be nullable"

if (cycle has CASCADE delete rules)
    → "CRITICAL: CASCADE in circular dependency can cause unintended cascading deletes"

if (cycle is self-reference)
    → "This is normal for hierarchical data (e.g., Employee → Manager)"
```

### Phase 3: Operator Override (M1.3)

**Goal**: Allow operators to acknowledge and allow specific cycles

**Configuration** (`circular-dependencies.json`):
```json
{
  "allowedCycles": [
    {
      "tables": ["OSUSR_USER", "OSUSR_ORGANIZATION"],
      "reason": "Bidirectional ownership relationship",
      "approvedBy": "Danny Dyer",
      "approvedDate": "2025-11-19",
      "loadStrategy": "PhaseLoad"
    }
  ],
  "strictMode": false
}
```

**Behavior**:
- If cycle matches allowlist → WARNING (not ERROR)
- If `strictMode=true` → ERROR even if allowed (zero-tolerance)
- Log allowance reason for audit trail

---

## Implementation Priority

### IMMEDIATE (This Session):

1. ✅ Analyze current state (DONE)
2. **Add `CycleDiagnostic` model** with minimal test
3. **Enhance TopologicalOrderingValidator.Validate()** to populate cycles
4. **Update BuildSsdtBootstrapSnapshotStep** to emit diagnostic

### SHORT-TERM (Next Session):

5. Add FK metadata extraction
6. Implement recommendations engine
7. Test with user's real circular dependency scenario

### FUTURE (M1.3):

8. Configuration-based allowlist
9. CLI flags for strict/warning modes
10. Documentation and examples

---

## Test Strategy

**Focus**: Minimal, reusable test data abstractions

**Core Test Cases** (no giant test plan, just essentials):

1. **Two-way cycle (A ↔ B)**: Simplest case
2. **Three-way cycle (A → B → C → A)**: Multi-hop
3. **Self-reference (Employee → Manager)**: Should NOT be reported as cycle
4. **Nullable FK in cycle**: Should recommend phased loading
5. **CASCADE delete in cycle**: Should warn about danger

**Test Data Builder**:
```csharp
// Reusable builder to avoid duplication
public static class CycleTestData
{
    public static (StaticEntityTableData[], OsmModel) CreateABCycle(
        bool nullableAtoB = false,
        bool nullableBtoA = false,
        string deleteRule = "NO ACTION")
    {
        // Shared logic for creating A ↔ B test scenarios
    }
}
```

---

## Key Business Logic Questions

### Question 1: Should self-references be reported as cycles?
**Recommendation**: NO
- Self-references are normal (Employee → Manager, Category → ParentCategory)
- Already handled correctly by current code (`parentIndex == childIndex` check)
- Should be listed separately in diagnostics for visibility

### Question 2: Should we FAIL on cycles or WARN?
**Current behavior**: WARN (alphabetical fallback)
**Recommendation**: Keep WARNING as default, add STRICT mode option
- Rationale: Circular dependencies aren't always fatal - can be handled with nullable FKs
- Operator should decide based on their constraints
- Strict mode for zero-tolerance environments

### Question 3: What makes a cycle "safe" vs "unsafe"?
**Safe cycle indicators**:
- At least one nullable FK (enables phased loading)
- No CASCADE delete rules
- Well-documented and intentional (e.g., User ↔ Organization ownership)

**Unsafe cycle indicators**:
- All FKs are NOT NULL (can't load data without circular INSERT)
- CASCADE delete in both directions (delete one row → cascade deletes everything)
- Accidental/unintended (indicates schema design issue)

### Question 4: Should we auto-suggest schema changes?
**Recommendation**: YES, but cautiously
- If all FKs are NOT NULL → "Consider making FK_X nullable"
- If CASCADE detected → "Consider changing to SET NULL or NO ACTION"
- Don't auto-apply changes - just suggest

---

## Next Steps

1. **Create `CycleDiagnostic` record** in TopologicalOrderingValidator.cs
2. **Implement cycle extraction** in Validate() method
3. **Write ONE focused test** (two-way cycle) to drive implementation
4. **Test against user's real scenario** to validate approach
5. **Iterate** based on findings

**Time estimate**: 2-3 hours for M1.2 core diagnostics
