# Profiling & Multi-Environment Strategy

## Intent, Guardrails, and Terminology Alignment
The profiling feature is the contract that bridges raw model ingestion with the tightening policies and SMO emission path. It must surface deterministic evidence without contaminating domain purity, so every section below cross-references the architectural guardrails and backlog expectations. Profiling executes entirely inside the Pipeline layer and publishes immutable domain objects (`ProfileSnapshot`, `MultiEnvironmentProfileReport`) back to Validation, ensuring that logical decisions remain testable and replayable as mandated by Guardrails §§1, 3, 4, and 6.【F:architecture-guardrails.md†L3-L31】【F:architecture-guardrails.md†L16-L27】 The bootstrapper that wraps profiling honors the fixture-first, deterministic execution plan captured in `tasks.md`, which requires every run (CI or operator-triggered) to prove the environment via mocks or live SQL while emitting reproducible telemetry.【F:tasks.md†L12-L28】【F:src/Osm.Pipeline/Orchestration/CaptureProfilePipeline.cs†L129-L226】

To clarify the request for explicit intent, each profiling action below is classified as either:

- **Reporting** – The action records facts, telemetry, or context to describe what happened. Reporting never mutates evidence; it exposes observability for operators, downstream automations, and auditors.
- **Intervention** – The action changes control flow or enforcement outcomes (e.g., fail fast, degrade gracefully, or aggregate data in a way that gates tightening decisions). Interventions are the safeguards that keep the hardening pipeline safe across environments.

The same action can emit reporting artifacts while also intervening. In those cases we call out the dual role explicitly so stakeholders can reason about repercussions when adjusting configuration knobs.

## Execution Flow Overview
The table below traces the single pass from request ingestion through artifact publication, highlighting the observable surface (Reporting) and the protective move (Intervention) taken at each step.

| Stage | Action | Nature | Outputs / Effects |
| --- | --- | --- | --- |
| Bootstrap | `CaptureProfilePipeline` validates inputs and wires the profiling delegate into the pipeline bootstrapper. | Intervention | Rejects missing model/output paths before execution; seeds telemetry builder for downstream logging.【F:src/Osm.Pipeline/Orchestration/CaptureProfilePipeline.cs†L104-L140】 |
| Bootstrap | Bootstrap context logs the profiling start/completion metadata. | Reporting | Structured log entries capture provider, module filters, counts, and timestamps for replay diagnostics.【F:src/Osm.Pipeline/Orchestration/BootstrapPipelineContext.cs†L136-L157】 |
| Provider selection | `DataProfilerFactory` chooses fixture vs. SQL profilers and constructs strict + lenient profiles when live SQL is requested. | Intervention | Enforces required connection/profile paths and injects table mapping + consensus knobs to control runtime behavior.【F:src/Osm.Pipeline/Profiling/DataProfilerFactory.cs†L27-L145】 |
| Single-environment capture | `SqlDataProfiler` composes metadata loaders, plan builders, and executors, applying concurrency and table mapping policies. | Reporting / Intervention | Logs skipped/mapped tables, enforces missing-table tolerance, and yields immutable column/constraint evidence used by policies.【F:src/Osm.Pipeline/Profiling/SqlDataProfiler.cs†L63-L211】 |
| Multi-environment capture | `MultiTargetSqlDataProfiler` orchestrates environment fan-out and merges snapshots conservatively. | Reporting / Intervention | Cancels on failure, records per-environment duration, and aggregates worst-case metrics before exposing them to consensus analysis.【F:src/Osm.Pipeline/Profiling/MultiTargetSqlDataProfiler.cs†L71-L198】 |
| Validation | `ProfilingStandardizationValidator` runs single- and cross-environment rules and translates them into findings. | Reporting / Intervention | Issues feed multi-environment findings and block unsafe consensus states when structural mismatches are present.【F:src/Osm.Pipeline/Profiling/ProfilingStandardizationValidator.cs†L22-L205】 |
| Consensus | `MultiEnvironmentConstraintConsensus` tallies readiness and formats remediation guidance. | Reporting / Intervention | Ratios gate constraint safety and inform operators about remediation priorities before tightening policies execute.【F:src/Osm.Pipeline/Profiling/MultiEnvironmentConstraintConsensus.cs†L34-L217】 |
| Publishing | `CaptureProfilePipeline` persists the snapshot, manifest, execution log, and optional report. | Reporting | Artifacts document the full capture context, module filters, and warnings for downstream promotion workflows.【F:src/Osm.Pipeline/Orchestration/CaptureProfilePipeline.cs†L151-L226】 |
| CLI exposure | `CommandConsole.EmitMultiEnvironmentReport` renders the structured report and consensus tables to operators. | Reporting | Console tables delineate safe vs. risky constraints and recommended actions, preserving audit visibility.【F:src/Osm.Cli/Commands/CommandConsole.cs†L620-L782】 |

The following sections dive into each stage with the requested 3×–5× level of detail, enumerating all reporting and intervention hooks.

## Stage 1 – Bootstrap Orchestration
1. **Input validation (Intervention).** Before the bootstrapper does any work, the pipeline verifies the model path and output directory; missing inputs produce deterministic validation errors and halt execution.【F:src/Osm.Pipeline/Orchestration/CaptureProfilePipeline.cs†L104-L183】 This prevents partial runs that would otherwise emit misleading telemetry.
2. **Telemetry seeding (Reporting).** `PipelineBootstrapTelemetry` captures provider identifiers, module filter shape, fixture overrides, and supplemental model toggles so the bootstrap log stream captures user intent alongside resulting evidence.【F:src/Osm.Pipeline/Orchestration/CaptureProfilePipeline.cs†L228-L245】
3. **Profiling delegate registration (Intervention).** The bootstrapper stores a pointer to `CaptureProfileAsync`. If the capture delegate fails, the bootstrapper aborts the pipeline and returns upstream errors, preventing downstream policy evaluation with stale evidence.【F:src/Osm.Pipeline/Orchestration/CaptureProfilePipeline.cs†L129-L281】
4. **Contextual logging (Reporting).** As soon as profiling starts, the context records a `profiling.capture.start` entry with provider metadata; upon completion, it records row, column, unique, and FK counts. These entries are consumed later by manifests and CLI telemetry bundles.【F:src/Osm.Pipeline/Orchestration/BootstrapPipelineContext.cs†L136-L157】
5. **Insight population (Reporting).** `ProfilerRunner` invokes the insight generator once a snapshot exists, storing advisory and warning level insights for manifest emission. These insights do not change behavior but give policy operators human-readable context for drift or data quality hotspots.【F:src/Osm.Pipeline/Orchestration/ProfilerRunner.cs†L38-L52】

## Stage 2 – Provider & Environment Selection
1. **Fixture routing (Intervention).** When the provider is `fixture`, the factory insists on a profile path and returns a serializer-backed profiler. This guarantees that deterministic fixtures remain opt-in and fail loudly if missing, honoring the fixture-first guardrail.【F:src/Osm.Pipeline/Profiling/DataProfilerFactory.cs†L45-L158】
2. **Live SQL routing (Intervention).** Selecting the SQL provider enforces a connection string and spins up strict + lenient `SqlDataProfiler` instances with shared naming overrides, command timeouts, and sampling knobs sourced from the scope configuration.【F:src/Osm.Pipeline/Profiling/DataProfilerFactory.cs†L55-L107】
3. **Environment labeling (Reporting).** The factory normalizes environment labels (primary, secondary, or provided aliases) and captures whether labels were adjusted. These flags later appear in the CLI summary table so operators can correlate evidence with specific databases.【F:src/Osm.Pipeline/Profiling/DataProfilerFactory.cs†L96-L144】【F:src/Osm.Cli/Commands/CommandConsole.cs†L648-L662】
4. **Consensus threshold wiring (Intervention).** When multiple environments are specified, the factory creates a `MultiTargetSqlDataProfiler` with a minimum consensus percentage derived from configuration. This threshold controls whether consensus marks a constraint as safe, allowing policy teams to tighten or relax gating without code changes.【F:src/Osm.Pipeline/Profiling/DataProfilerFactory.cs†L138-L145】【F:src/Osm.Pipeline/Profiling/MultiEnvironmentConstraintConsensus.cs†L34-L77】

## Stage 3 – Single-Environment SQL Capture
1. **Metadata hydration (Reporting).** `SqlDataProfiler` gathers column definitions and row counts up front, ensuring that downstream plans reference authoritative schema state. These metadata calls populate the optional `SqlMetadataLog`, which feeds CLI telemetry and troubleshooting reports.【F:src/Osm.Pipeline/Profiling/SqlDataProfiler.cs†L63-L113】
2. **Table plan construction (Intervention).** The profiler builds per-table execution plans that respect missing-table tolerance, table mappings, and concurrency settings. Missing tables in lenient mode are recorded instead of failing outright so multi-environment runs can continue while still producing actionable findings.【F:src/Osm.Pipeline/Profiling/SqlDataProfiler.cs†L74-L112】
3. **Parallel execution throttling (Intervention).** Depending on `MaxConcurrentTableProfiles`, the profiler either runs sequentially or spins up `Parallel.ForEachAsync` with a bounded degree of parallelism. This ensures the capture process scales while respecting infrastructure constraints configured by operators.【F:src/Osm.Pipeline/Profiling/SqlDataProfiler.cs†L115-L144】
4. **Evidence materialization (Reporting).** As each plan finishes, the profiler creates domain-level column, unique, composite, and foreign-key profiles with immutable counts, probe status metadata, and optional null row samples. These records feed policy evaluation without further mutation, satisfying the logical/physical separation guardrail.【F:src/Osm.Pipeline/Profiling/SqlDataProfiler.cs†L146-L211】【F:architecture-guardrails.md†L16-L27】
5. **Probe diagnostics (Reporting).** Probe results capture elapsed time, sample size, and status; warnings are later surfaced by the standardization validator when probes fail or produce inconclusive outcomes. Operators receive this detail in CLI findings and manifests.【F:src/Osm.Pipeline/Profiling/SqlDataProfiler.cs†L170-L211】【F:src/Osm.Pipeline/Profiling/ProfilingStandardizationValidator.cs†L114-L177】

## Stage 4 – Multi-Environment Fan-Out & Aggregation
1. **Parallel environment capture (Intervention).** `MultiTargetSqlDataProfiler` applies a semaphore to honor `maxDegreeOfParallelism` and cancels pending captures if any environment fails. This failsafe prevents partial aggregation that could mislead consensus or tightening decisions.【F:src/Osm.Pipeline/Profiling/MultiTargetSqlDataProfiler.cs†L71-L156】
2. **Duration tracking (Reporting).** Each environment capture records elapsed time that later appears in the CLI summary and findings, helping teams reason about performance regressions or connectivity issues across environments.【F:src/Osm.Pipeline/Profiling/MultiTargetSqlDataProfiler.cs†L158-L173】【F:src/Osm.Cli/Commands/CommandConsole.cs†L648-L662】
3. **Worst-case merge (Intervention).** When more than one snapshot exists, the profiler merges them using worst-case aggregation: maximum row/null counts, OR semantics for duplicate/orphan flags, and the most severe probe outcome. This conservative merge ensures downstream tightening only proceeds when **every** environment is healthy.【F:src/Osm.Pipeline/Profiling/MultiTargetSqlDataProfiler.cs†L175-L244】
4. **Report creation (Reporting).** After aggregation, the profiler builds a `MultiEnvironmentProfileReport` capturing environment summaries, findings, and consensus analysis for distribution to operators and policy consumers.【F:src/Osm.Pipeline/Profiling/MultiTargetSqlDataProfiler.cs†L101-L116】【F:src/Osm.Pipeline/Profiling/MultiEnvironmentProfileReport.cs†L20-L58】

## Stage 5 – Validation & Findings Expansion
1. **Per-environment validation (Reporting / Intervention).** The standardization validator walks each snapshot, producing warnings or errors when row counts are inconsistent, probes fail, or schema metadata conflicts with data. Errors can be elevated by downstream policy gates, while advisories help operators triage evidence gaps.【F:src/Osm.Pipeline/Profiling/ProfilingStandardizationValidator.cs†L22-L205】
2. **Cross-environment validation (Intervention).** The validator compares schema shape, data quality, and constraint agreement across snapshots. Issues are promoted into the report as multi-environment findings with severity mappings and suggested remediation, guiding operators to align environments before enforcing constraints.【F:src/Osm.Pipeline/Profiling/MultiEnvironmentProfileReport.cs†L42-L207】
3. **Finding taxonomy (Reporting).** Each finding includes a code, title, severity, summary, suggested action, and affected objects. This schema underpins CLI output and JSON manifests so incident responders can search and automate on consistent identifiers.【F:src/Osm.Pipeline/Profiling/MultiEnvironmentProfileReport.cs†L80-L207】

## Stage 6 – Constraint Consensus & Readiness Signaling
1. **Consensus computation (Intervention).** `MultiEnvironmentConstraintConsensus.Analyze` tallies safe vs. unsafe constraints for NOT NULL, UNIQUE, and FK scopes based on the configured threshold. Constraints missing from any environment or showing data violations fail the safety test, preventing premature tightening.【F:src/Osm.Pipeline/Profiling/MultiEnvironmentConstraintConsensus.cs†L34-L208】
2. **Statistics and recommendations (Reporting).** The consensus object records aggregate counts and renders text guidance (e.g., “resolve duplicates” or “standardize table casing”), which are displayed in CLI tables and can be serialized to manifests for governance reviews.【F:src/Osm.Pipeline/Profiling/MultiEnvironmentConstraintConsensus.cs†L88-L138】【F:src/Osm.Cli/Commands/CommandConsole.cs†L702-L777】
3. **Dual-surface availability (Reporting).** Both the raw consensus data and formatted report are exposed so future telemetry sinks can ingest machine-readable counts while operators receive curated narratives. This duality satisfies guardrails around observability and audit readiness.【F:src/Osm.Pipeline/Profiling/MultiEnvironmentConstraintConsensus.cs†L81-L138】【F:architecture-guardrails.md†L24-L31】

## Stage 7 – Artifact Publishing & CLI Surfaces
1. **Snapshot & manifest persistence (Reporting).** After capture, the pipeline writes `profile.json` and `manifest.json` alongside telemetry metadata, warnings, and insight summaries. Failures during persistence convert to validation errors, ensuring partial artifacts never leak onto disk.【F:src/Osm.Pipeline/Orchestration/CaptureProfilePipeline.cs†L151-L226】
2. **Execution log capture (Reporting).** The pipeline execution log includes manifest paths, counts, and timestamps. Operators reference this log when chaining profiling runs in CI or when diagnosing environment drift.【F:src/Osm.Pipeline/Orchestration/CaptureProfilePipeline.cs†L208-L225】
3. **CLI tabular output (Reporting).** `CommandConsole.EmitMultiEnvironmentReport` prints environment summary tables, enumerates findings with suggested actions, and renders consensus matrices that separate safe vs. risky constraints. This is the primary operator touchpoint for interpreting profiling output without cracking open JSON artifacts.【F:src/Osm.Cli/Commands/CommandConsole.cs†L620-L777】
4. **Readiness digest (Intervention via communication).** Although the CLI does not mutate evidence, it highlights risk categories (null variance, uniqueness drift, orphan FKs) per environment. These digests drive operator interventions—such as pausing tightening or remediating data—before the next promotion step.【F:src/Osm.Cli/Commands/CommandConsole.cs†L785-L820】

## Stage 8 – Configuration Surfaces & Operator Controls
1. **SQL profiler options (Intervention).** `SqlProfilerOptions` expose command timeouts, sampling thresholds, concurrency, missing-table tolerance, and table mappings, letting operators tune behavior without code changes.【F:src/Osm.Pipeline/Sql/SqlProfilerOptions.cs†L1-L72】 These knobs directly influence whether profiling times out, skips drifted tables, or captures high-volume samples.
2. **Consensus threshold & labeling (Reporting / Intervention).** Environment configuration supplies consensus ratios and human-readable labels. Labels power reporting, while thresholds govern interventions that gate constraint readiness.【F:src/Osm.Pipeline/Profiling/DataProfilerFactory.cs†L96-L145】【F:src/Osm.Pipeline/Profiling/MultiEnvironmentConstraintConsensus.cs†L34-L208】
3. **Fixture vs. live switching (Intervention).** CLI and configuration settings control whether profiling runs offline fixtures or live SQL. Fixture mode guarantees deterministic evidence for CI smoke tests, whereas live mode activates intervention logic (fail-fast, consensus gating) for production-readiness sweeps.【F:src/Osm.Pipeline/Profiling/DataProfilerFactory.cs†L45-L145】【F:tasks.md†L12-L28】
4. **Telemetry consumers (Reporting).** All emitted artifacts—snapshot, manifest, execution log, multi-environment report—feed downstream pipelines and governance tooling. Operators can diff snapshots over time, while policy teams can attach consensus evidence to release approvals, satisfying observability guardrails.【F:src/Osm.Pipeline/Orchestration/CaptureProfilePipeline.cs†L208-L226】【F:architecture-guardrails.md†L24-L31】

## Stage 9 – Downstream Policy Integration
1. **Immutable evidence hand-off (Intervention).** Profiling returns pure domain models to tightening policies, letting policy code treat evidence as read-only inputs. This enforces the guardrail that logical decisions remain deterministic and auditable even when profiling strategies evolve.【F:src/Osm.Pipeline/Orchestration/ProfilerRunner.cs†L38-L52】【F:architecture-guardrails.md†L16-L27】
2. **Multi-environment context propagation (Reporting / Intervention).** When present, the `MultiEnvironmentProfileReport` rides along in the bootstrap context and pipeline result, so policies and manifests can cite consensus ratios before enabling aggressive hardening modes.【F:src/Osm.Pipeline/Orchestration/CaptureProfilePipeline.cs†L217-L225】【F:src/Osm.Pipeline/Orchestration/BootstrapPipelineContext.cs†L159-L188】
3. **Runbook alignment (Reporting).** The backlog explicitly calls for documenting toggle strategies and operator runbooks. The expanded profiling documentation you are reading satisfies that requirement by mapping each action to its reporting and intervention outcome, allowing teams to reason about the consequences of tuning knobs ahead of tightening efforts.【F:tasks.md†L42-L46】

## Stage 10 – Tightening Modes & Mode-Specific Interventions
Profiling evidence ultimately drives one of three policy envelopes: **Cautious**, **EvidenceGated**, or **Aggressive**. The `TighteningPolicyMatrix` defines which signals tighten vs. report, how missing probes are handled, and when remediation is demanded.【F:src/Osm.Validation/Tightening/TighteningPolicyMatrix.cs†L11-L195】【F:src/Osm.Validation/Tightening/TighteningPolicyMatrix.cs†L237-L400】 The table below summarizes how each mode interprets the profiled data.

| Mode | Nullability intervention | Unique intervention | Foreign-key intervention | Remediation strategy | Reporting emphasis |
| --- | --- | --- | --- | --- | --- |
| **Cautious** | Tightens only on primary keys, physical NOT NULL columns, and OutSystems mandatory attributes; foreign-key and unique cleanliness signals stay telemetry-only.【F:src/Osm.Validation/Tightening/TighteningPolicyMatrix.cs†L97-L190】 | Enforces existing physical unique keys (including duplicate clean-up when a physical constraint already exists) but treats profiler-derived “clean” signals as advisory only.【F:src/Osm.Validation/Tightening/TighteningPolicyMatrix.cs†L270-L309】 | Honors toggle blocks (policy disabled, cross-schema/catalog) and existing constraints, but skips creation when orphans or delete-rule `Ignore` are present.【F:src/Osm.Validation/Tightening/TighteningPolicyMatrix.cs†L330-L369】【F:notes/design-contracts.md†L108-L119】 | Never injects remediation by default; optional `allowCautiousNullabilityRelaxation` guard can force remediation before relaxing mandatory attributes.【F:src/Osm.Validation/Tightening/NullabilityEvaluator.cs†L140-L156】【F:src/Osm.Domain/Configuration/TighteningOptions.cs†L110-L143】 | CLI summaries call out that FK and unique evidence are informational so operators know why enforcement did or did not occur.【F:src/Osm.Validation/Tightening/PolicyDecisionSummaryFormatter.cs†L144-L228】 |
| **EvidenceGated** | Adds FK and unique signals to the tightening tree but requires profiler proof (no nulls/duplicates, within null budget) before flipping enforcement.【F:src/Osm.Validation/Tightening/TighteningPolicyMatrix.cs†L130-L159】【F:notes/design-contracts.md†L70-L74】 | Enforces unique indexes when profiling shows the data is already clean; missing probes keep enforcement off without remediation noise.【F:src/Osm.Validation/Tightening/TighteningPolicyMatrix.cs†L312-L348】【F:notes/design-contracts.md†L93-L99】 | Creates foreign keys only when profiling reports no orphans and configuration allows the relationship, keeping consensus evidence as the gate.【F:notes/design-contracts.md†L108-L119】 | Relies on evidence; if probes are missing the decision stays telemetry-only so operators can rerun profiling without remediation debt.【F:src/Osm.Validation/Tightening/TighteningPolicyMatrix.cs†L150-L158】【F:notes/design-contracts.md†L70-L99】 | CLI copy explains that referential and uniqueness enforcement occurred because evidence passed the gate, reinforcing the telemetry-to-action chain.【F:src/Osm.Validation/Tightening/PolicyDecisionSummaryFormatter.cs†L144-L228】 |
| **Aggressive** | Treats FK and unique signals as immediate interventions and adds remediation requirements whenever the profiler lacks proof, forcing operators to remediate before promotion.【F:src/Osm.Validation/Tightening/TighteningPolicyMatrix.cs†L160-L190】【F:src/Osm.Validation/Tightening/NullabilityEvaluator.cs†L132-L155】 | Always enforces unique indexes except when the policy toggle is disabled, attaching `REMEDIATE_BEFORE_TIGHTEN` whenever duplicates or missing evidence remain.【F:src/Osm.Validation/Tightening/TighteningPolicyMatrix.cs†L352-L396】【F:notes/design-contracts.md†L99-L105】 | Enables foreign-key creation wherever allowed and marks missing evidence as remediation-required so drift is addressed before shipping.【F:notes/design-contracts.md†L108-L119】 | Automatically upgrades mandatory columns to NOT NULL and tags gaps with remediation directives, ensuring aggressive runs never quietly degrade enforcement.【F:src/Osm.Validation/Tightening/NullabilityEvaluator.cs†L132-L155】 | CLI summaries highlight remediation blockers and mandatory overrides so release managers can queue the necessary data fixes.【F:src/Osm.Validation/Tightening/PolicyDecisionSummaryFormatter.cs†L144-L228】 |

### Configuration & Toggle Implications
- **Policy surface.** `TighteningOptions` exposes the selected mode, the acceptable null budget, and the `allowCautiousNullabilityRelaxation` escape hatch. This keeps “Cautious but flexible” runs explicit and auditable in configuration files and CLI inputs.【F:src/Osm.Domain/Configuration/TighteningOptions.cs†L6-L144】
- **Remediation semantics.** `NullabilityEvaluator` injects remediation rationales when Cautious mode blocks mandatory relaxation or when Aggressive mode tightens without evidence, ensuring profiling gaps translate into actionable remediation tickets instead of silent enforcement.【F:src/Osm.Validation/Tightening/NullabilityEvaluator.cs†L140-L190】
- **Telemetry parity.** Even when enforcement is skipped (e.g., EvidenceGated without probes), the policy matrix emits rationale codes such as `PROFILE_MISSING`, `DATA_NO_NULLS`, or `UNIQUE_NO_NULLS`, which the CLI and manifests display for traceability across modes.【F:src/Osm.Validation/Tightening/TighteningPolicyMatrix.cs†L60-L195】【F:notes/design-contracts.md†L61-L105】

By pairing profiling outputs with these mode-specific interventions, operators can predict exactly how Cautious, EvidenceGated, and Aggressive runs will behave, what remediation debt they incur, and which telemetry explains each decision before SMO emission proceeds.

---
By cataloging every profiling action with explicit reporting vs. intervention intent, this guide clarifies how evidence flows from SQL sampling to operator-facing artifacts. Teams can now adjust configuration thresholds, enable multi-environment sweeps, or rely on fixtures with confidence that each tweak has a documented behavioral footprint.
